 Pricebuddy update_ 12.11.2025

ì§€ê¸ˆ êµ¬í˜„ ìƒíƒœ ê½¤ ì˜ ë‚˜ì™”ì–´.
ì´ì œë¶€í„°ëŠ” â€œë°ëª¨ìš© V1â€ì—ì„œ ì§„ì§œ ì¥ê¸° ìš´ì˜ ê°€ëŠ¥í•œ í”„ë¡œë•ì…˜ êµ¬ì¡°ë¡œ ê°ˆì•„íƒ€ëŠ” ë‹¨ê³„ë¼ì„œ,
ì½”ë“œ ë ˆë²¨ì—ì„œ ë­˜ ê³ ì³ì•¼ í• ì§€/ì–´ë–»ê²Œ í™•ì¥í•´ì•¼ í• ì§€ ë‹¨ê³„ë³„ë¡œ ì§šì–´ë³¼ê²Œ.

â¸»

0. í˜„ì¬ ìƒíƒœ ìš”ì•½ (ë‚´ê°€ ë³¸ ê²ƒ)
	â€¢	UI
	â€¢	ëœë”© / ê²€ìƒ‰ / ìƒí’ˆ ìƒì„¸ / ê¸€ë¡œë²Œ ê²€ìƒ‰ê¹Œì§€ íë¦„ì€ ì˜ ì¡í˜€ ìˆìŒ.
	â€¢	â€œì˜¤ëŠ˜ë§Œ ì´ˆíŠ¹ê°€ ë”œâ€, AI Signal, Price History, Offers ì¹´ë“œ ë“± í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë„ ê´œì°®ìŒ.
	â€¢	FE ìŠ¤íƒ
	â€¢	React 19 + Vite + Tailwind + Recharts â†’ ìš”ì¦˜ ê¸°ì¤€ìœ¼ë¡œ OK.
	â€¢	repo êµ¬ì¡°ëŠ” ì•„ë§ˆ web_app ë‹¨ì¼ ì•± í˜•íƒœ + ê³µí†µ libs ì •ë„.
	â€¢	BE / ì¸í…”ë¦¬ì „ìŠ¤
	â€¢	Firebase Functions + Firestore (NoSQL)
	â€¢	Scraper ì—”ì§„ì€ adapter êµ¬ì¡°ë¡œ ë˜ì–´ ìˆê³  ì¼ë¶€ mock, Puppeteer/cheerioë¡œ í™•ì¥ ì˜ˆì •.
	â€¢	Pricing / Forecast / Review / Promo ì—”ì§„ì€ ì´ë¯¸ 1ì°¨ êµ¬í˜„.
	â€¢	AI ë¦¬ë·°ëŠ” OpenAI (GPT-4o-mini) ì˜ì¡´.

ì´ ìƒíƒœë©´ â€œë°ëª¨ & ì´ˆê¸° ë² íƒ€â€ë¡œëŠ” ì¶©ë¶„í•œë°,
ì¥ê¸°ì ìœ¼ë¡œ MAU ìˆ˜ì‹­~ìˆ˜ë°±ë§Œ / ì¼ ìˆ˜ì‹­ë§Œ ìš”ì²­ê¹Œì§€ ìƒê°í•˜ë©´ êµ¬ì¡°ë¥¼ ì¢€ ë” ë‹¨ë‹¨í•˜ê²Œ ì§œì•¼ í•  í¬ì¸íŠ¸ë“¤ì´ ìˆìŒ.

ì•„ë˜ë¶€í„°ëŠ” â€œì‹¤ì œ ì½”ë“œ PR ê³„íšâ€ ìˆ˜ì¤€ìœ¼ë¡œ ìª¼ê°œì„œ ì´ì•¼ê¸°í• ê²Œ.

â¸»

1. FE ì•„í‚¤í…ì²˜: â€œí˜ì´ì§€+ì»´í¬ë„ŒíŠ¸â€ â†’ â€œê¸°ëŠ¥ ëª¨ë“ˆâ€ êµ¬ì¡°ë¡œ

1-1. ê¸°ëŠ¥ë³„ ë””ë ‰í„°ë¦¬ êµ¬ì¡°ë¡œ ë¦¬íŒ©í„°ë§

ì§€ê¸ˆ ìƒíƒœê°€ pages/ ì•ˆì— ëœë”©/ê²€ìƒ‰/ìƒì„¸ê°€ ì„ì—¬ ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì„œ,
ì•„ì˜ˆ ê¸°ëŠ¥ ëª¨ë“ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²Œ ì¢‹ì•„.

src/
  app/                // ë¼ìš°íŒ… ì—”íŠ¸ë¦¬
  features/
    search/
      components/
      api/
      hooks/
    product-detail/
      components/
      api/
      hooks/
    deals/
    wallet/
    auth/
  shared/
    ui/               // ë²„íŠ¼, ì¹´ë“œ, ëª¨ë‹¬ ê°™ì€ ê³µí†µ UI
    lib/              // util, ë‚ ì§œ/í™”í í¬ë§· ë“±
    config/

ì´ë ‡ê²Œ í•´ë‘ë©´:
	â€¢	Antigravity/AI ì½”ë“œê°€ ì„ì—¬ë„ feature ë‹¨ìœ„ë¡œ ê°ˆì•„ë¼ìš°ê¸° ì‰¬ì›€
	â€¢	ë‚˜ì¤‘ì— ì•± / í™•ì¥ / B2Bë„ ê°™ì€ feature êµ¬ì¡°ë¥¼ ì¬ì‚¬ìš©í•˜ê¸° ì¢‹ìŒ.

1-2. ë°ì´í„° íŒ¨ì¹­ ê³„ì¸µ í†µì¼ (TanStack Query ê°•ì¶”)

ê° í˜ì´ì§€ì—ì„œ useEffect + fetchë¥¼ ì§ì ‘ ì“°ê³  ìˆë‹¤ë©´,
TanStack Query(react-query)ë¡œ íŒ¨ì¹­ ê³„ì¸µì„ í†µì¼í•˜ëŠ” ê²Œ ì¢‹ì•„.

// src/features/search/api/useSearch.ts
import { useQuery } from "@tanstack/react-query";
import { http } from "@/shared/lib/http";

export function useSearch(query: string, region: string) {
  return useQuery({
    queryKey: ["search", query, region],
    queryFn: () => http.get<SearchResult>("/api/search", { query, region }),
    enabled: !!query,
  });
}

ì´ë ‡ê²Œ í•˜ë©´:
	â€¢	ìºì‹± / ì—ëŸ¬ / ë¡œë”© ìƒíƒœë¥¼ í†µì¼
	â€¢	ë¸Œë¼ìš°ì € í™•ì¥, ëª¨ë°”ì¼ì—ì„œ ê°™ì€ í›… ì¬ì‚¬ìš© ê°€ëŠ¥

1-3. Skeleton & ErrorBoundary í‘œì¤€í™”

ì´ë¯¸ â€œRunning in emulator modeâ€¦â€ ë°°ë„ˆê°€ ìˆìœ¼ë‹ˆê¹Œ,
ì—ëŸ¬/ë¡œë”© UIë„ ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¡œ ë¬¶ëŠ” ê²Œ ì¢‹ë‹¤.

// shared/ui/AsyncBoundary.tsx
export function AsyncBoundary({ isLoading, error, children }) {
  if (isLoading) return <SkeletonPage />;
  if (error) return <ErrorState message="ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”." />;
  return children;
}

í˜ì´ì§€ì—ì„œ ë§¤ë²ˆ if (loading) ì•ˆ ì“°ê³ ,
<AsyncBoundary>ë¡œ ê°ì‹¸ì„œ ê´€ë¦¬.

â¸»

2. Backend: Firebase Functions í•œ ë©ì–´ë¦¬ â†’ ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë¶„ë¦¬

ì§€ê¸ˆì€ services/api ì•„ë˜ Cloud Functionsê°€ ì—¬ëŸ¬ ì—­í• (scraping, pricing, intelligence)ì„ ë‹¤ í•˜ê³  ìˆì–´ì„œ,
ê·œëª¨ ì»¤ì§€ë©´ ì˜ë„ì¹˜ ì•Šì€ ê²°í•©ì´ ìƒê¸°ê¸° ì‰¬ì›Œ.

2-1. ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë¶„ë¦¬ êµ¬ì¡° ì œì•ˆ

services/
  api/          # HTTP ì—”ë“œí¬ì¸íŠ¸ (BFF ê°œë…)
  scraper/      # Playwright/cheerioë¡œ í¬ë¡¤ë§
  pricing/      # í™˜ìœ¨/ê´€ì„¸/ë°°ì†¡/ì´ì•¡ ê³„ì‚°
  intelligence/
    forecast/
    review/
    promo/
  matcher/      # SKU ë§¤ì¹­

	â€¢	apiëŠ” Firebase Functions (ë˜ëŠ” Cloud Run BFF)
	â€¢	scraper, matcher, intelligenceëŠ” Cloud Run ë‹¨ë… ì„œë¹„ìŠ¤ë¡œ ì ì§„ì  ë¶„ë¦¬
(ì´ˆê¸°ì—ëŠ” ê°™ì€ Functions ì•ˆì— ìˆë‹¤ê°€, ë¶€í•˜ ì˜¬ë¼ê°€ë©´ serviceë³„ë¡œ ìª¼ê°œê¸°)

ì˜ˆì‹œ: APIì—ì„œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ

// services/api/src/handlers/getProductOffers.ts
import { pricingClient } from "@pricebuddy/clients/pricing";
import { scrapeClient } from "@pricebuddy/clients/scraper";

export async function getProductOffers(req, res) {
  const { url, country } = req.query;

  const rawOffers = await scrapeClient.fetchOffers(url);
  const priced = await pricingClient.computePrices(rawOffers, country);

  res.json({ offers: priced });
}

ì´ êµ¬ì¡°ë©´:
	â€¢	ë‚˜ì¤‘ì— scraperë§Œ Node 22 / Playwright / Puppeteer íŠ¹í™” ì»¨í…Œì´ë„ˆë¡œ ë°”ê¿”ë„ ë¨
	â€¢	API ê³„ì¸µì€ â€œì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ + ì¸ì¦â€ ì •ë„ë§Œ ë‹´ë‹¹

2-2. Firestore ëª¨ë¸ë§ ë³´ê°•

Price history, alerts, walletì€ ì¥ê¸°ì ìœ¼ë¡œ ë°ì´í„° ë§ì•„ì§€ë‹ˆê¹Œ, ëª¨ì–‘ì„ ë¯¸ë¦¬ ì˜ ì¡ì•„ì•¼ í•¨.

products/{productId}
  title
  brand
  ...

offers/{offerId}
  productId
  marketplace
  externalId
  latestPriceKrw
  ...

price_history/{offerId}/{day}
  ts: timestamp
  priceKrw
  ...

	â€¢	price_historyë¥¼ ë³„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë¹¼ì„œ,
	â€¢	ì˜¤ëŠ˜ ê°€ê²©: offers ì—
	â€¢	ê³¼ê±° ê°€ê²©: price_history ì— ì €ì¥
â†’ ì°¨íŠ¸ëŠ” price_history ì¿¼ë¦¬

â¸»

3. Scraper ì—”ì§„: â€œëª¨ë“ˆ ì–´ëŒ‘í„°â€ â†’ â€œì„¤ì • ê¸°ë°˜ + í ê¸°ë°˜ íŒŒì´í”„ë¼ì¸â€

ì§€ê¸ˆ â€œëª¨ë“ˆ ì–´ëŒ‘í„°â€ êµ¬ì¡°ëŠ” ì¢‹ì•„.
ì—¬ê¸°ì„œ í•œ ë‹¨ê³„ë§Œ ë” ê°€ë©´ ìš´ì˜ ë‚œì´ë„ê°€ í™• ì¤„ì–´.

3-1. config-driven selector

ê° ë§ˆì¼“ë§ˆë‹¤ DOM êµ¬ì¡°ê°€ ë°”ë€Œë©´ ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”í•˜ë‹ˆê¹Œ,
ê°€ëŠ¥í•œ í•œ â€œCSS selectorì™€ ë£°ì„ configë¡œ ë¹¼ë‘ëŠ” ê²ƒâ€ ì¶”ì²œ.

// services/scraper/src/config/coupang.ts
export const coupangConfig = {
  title: "h2.prod-buy-header__title",
  price: "#totalPrice",
  shippingFee: "#shippingFee",
  // ...
};

íŒŒì„œì—ì„œ:

export function parseWithConfig(html: string, config: SelectorConfig): ParsedOfferOutput {
  const $ = load(html);
  const title = $(config.title).text().trim();
  const price = parsePrice($(config.price).text());
  ...
}

3-2. í ê¸°ë°˜ ìˆ˜ì§‘

ì§€ê¸ˆì€ â€œìš”ì²­ ì˜¬ ë•Œë§ˆë‹¤ ë°”ë¡œ í¬ë¡¤ë§â€ ë°©ì‹ì¼ ê°€ëŠ¥ì„±ì´ í°ë°,
ë‚˜ì¤‘ì—ëŠ” Background Job Queue ì“°ëŠ” ê²Œ í›¨ì”¬ ì•ˆì •ì .
	â€¢	Cloud Tasks, Pub/Sub, or simple Firestore queue ì»¬ë ‰ì…˜
	â€¢	APIëŠ” â€œjob ìƒì„± â†’ ê¸°ì¡´ ìºì‹œ ìˆìœ¼ë©´ ë°”ë¡œ ì‘ë‹µ, ìµœì‹  ë°ì´í„°ëŠ” ë¹„ë™ê¸° ê°±ì‹ â€

â¸»

4. AI & Intelligence: ì™¸ë¶€ API ì¤„ì´ê³ , ìì²´ ì—”ì§„ ê°•í™” í”Œëœ

ë„ˆê°€ ë§í•œëŒ€ë¡œ ì™¸ë¶€ API ì˜ì¡´ ì¤„ì´ëŠ” ë°©í–¥ìœ¼ë¡œ ë³´ê°•í•˜ì.

4-1. Review Engine: GPT â†’ ë¡œì»¬ ë©€í‹°ì–¸ì–´ ëª¨ë¸
	â€¢	ì§€ê¸ˆ:
	â€¢	GPT-4o-mini ë¡œ ë¦¬ë·° ê°ì„±/í‚¤ì›Œë“œ ë¶„ì„
	â€¢	ê°œì„ :
	â€¢	services/reviewì—ì„œ HuggingFace ë©€í‹°ì–¸ì–´ sentiment + keyphrase ëª¨ë¸ ë¡œì»¬ ë¡œë“œ
	â€¢	Cloud Run ì»¨í…Œì´ë„ˆë¡œ ëŒë¦¬ë©´ ì™„ì „ ìë¦½ êµ¬ì¡° ê°€ëŠ¥

ì½”ë“œ ìŠ¤ì¼€ì¹˜:

# services/review/app.py
from fastapi import FastAPI
from transformers import AutoTokenizer, AutoModelForSequenceClassification
import torch

app = FastAPI()
tok = AutoTokenizer.from_pretrained("nlptown/bert-base-multilingual-uncased-sentiment")
model = AutoModelForSequenceClassification.from_pretrained(...)

@app.post("/analyze")
def analyze(req: AnalyzeRequest):
    # texts: list[str]
    # 1) sentiment score í‰ê· 
    # 2) ê°„ë‹¨ TF-IDFë¡œ pros/cons í‚¤ì›Œë“œ ì¶”ì¶œ
    ...

4-2. Forecast Engine: ë‹¨ìˆœ íšŒê·€ â†’ ì‹œê³„ì—´ ëª¨ë¸(ARIMA or Prophet)ë¡œ ë¶„ë¦¬

ì§€ê¸ˆ simple-statisticsë¡œ ì„ í˜•íšŒê·€ë¼ë©´:
	â€¢	ê°€ê²©ì´ ê³„ì ˆì„±/ì„¸ì¼ íŒ¨í„´ ê°–ëŠ” ìˆœê°„ ì˜ˆì¸¡ë ¥ì´ ë–¨ì–´ì§
	â€¢	services/forecastë¥¼ Python microserviceë¡œ ë–¼ê³ ,
statsmodels(sarimax) ë˜ëŠ” Prophetìœ¼ë¡œ ì‹œê³„ì—´ ì˜ˆì¸¡

â¸»

5. Matcher / Vector DB: Pinecone ê°™ì€ ì™¸ë¶€ ì„œë¹„ìŠ¤ ëŒ€ì‹  pgvector ì¶”ì²œ

ì™¸ë¶€ Vector DBë¥¼ ì“°ë©´ í¸í•˜ê¸´ í•˜ì§€ë§Œ,
â€œì˜ì¡´ ì¤„ì¸ë‹¤â€ ëª©í‘œë©´ Postgres + pgvector ë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ì»¤ë²„ ê°€ëŠ¥.
	â€¢	libs/infraì— pg í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€
	â€¢	products í…Œì´ë¸”ì— embedding vector ì¹¼ëŸ¼ ì¶”ê°€
	â€¢	SELECT ... ORDER BY embedding <-> $1 LIMIT 10 ë°©ì‹ìœ¼ë¡œ ìœ ì‚¬ë„ ê²€ìƒ‰

TypeORM ì˜ˆì‹œ:

const similar = await dataSource
  .getRepository(ProductEntity)
  .createQueryBuilder("p")
  .orderBy("p.embedding <-> :vec", "ASC")
  .setParameters({ vec })
  .limit(10)
  .getMany();


â¸»

6. Wallet / Referral / Cashback: â€œì”ê³  ìˆ«ìâ€ â†’ â€œì›ì¥(ledger)â€ ëª¨ë¸ë¡œ

ì§€ê¸ˆì€ Firestoreì— ì”ê³  ìˆ«ìë§Œ ë“¤ê³  ìˆì„ í™•ë¥ ì´ ë†’ì€ë°,
ëˆì´ ê±¸ë¦¬ëŠ” ë¶€ë¶„ì€ ë°˜ë“œì‹œ ì›ì¥ í…Œì´ë¸”(íŠ¸ëœì­ì…˜ ë¡œê·¸)ë¡œ ê´€ë¦¬í•˜ëŠ” ê²Œ ë§ë‹¤.

wallets/{userId}
  balance: number

wallet_ledger/{entryId}
  userId
  type: "cashback" | "withdrawal" | "referral_bonus"
  amount
  createdAt
  relatedOrderId

	â€¢	ì”ê³ ëŠ” ledger ì§‘ê³„ê°’
	â€¢	UIëŠ” ledgerë¥¼ í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ë³´ì—¬ì¤Œ
	â€¢	ë‚˜ì¤‘ì— ì‘ì€ ë²„ê·¸ ë‚˜ë„ ledger ì¬ì§‘ê³„í•˜ë©´ ë³µêµ¬ ê°€ëŠ¥

â¸»

7. í’ˆì§ˆ: í…ŒìŠ¤íŠ¸ / ìŠ¤í† ë¦¬ë¶ / e2e

7-1. FE: Storybook + Jest/RTL
	â€¢	ëœë”© íˆì–´ë¡œ, ë”œ ì¹´ë“œ, ê°€ê²©ì¹´ë“œ, AI Signal ì»´í¬ë„ŒíŠ¸ì— Storybook ì •ì˜
	â€¢	@testing-library/reactë¡œ í•µì‹¬ UI ë¡œì§ ê°„ë‹¨ í…ŒìŠ¤íŠ¸

7-2. BE: ë‹¨ìœ„í…ŒìŠ¤íŠ¸ + ê³„ì•½ í…ŒìŠ¤íŠ¸
	â€¢	Pricing / Tax / Shipping ì—”ì§„ì€ í…ŒìŠ¤íŠ¸ í•„ìˆ˜.
	â€¢	computePriceì— ëŒ€í•´ ì—¬ëŸ¬ ë‚˜ë¼/ê¸ˆì•¡/ë¬´ê²Œ ì¼€ì´ìŠ¤ ë‹¤ ë„£ì–´ë³´ê¸°.

test("KR under threshold has zero tax", () => {
  const out = computePrice({ country: "KR", basePrice: 100, currency: "USD" });
  expect(out.taxFeeKrw).toBe(0);
});


â¸»

8. â€œì§€ê¸ˆ V1ì—ì„œ ë‹¹ì¥ í•  ë§Œí•œ 7ê°€ì§€ ì‘ì—…â€ ì •ë¦¬
	1.	web_app ë¦¬íŒ©í„°ë§
	â€¢	features ë””ë ‰í„°ë¦¬ êµ¬ì¡° ì ìš©
	â€¢	TanStack Query ë„ì…
	2.	API ë ˆì´ì–´ ì •ë¦¬
	â€¢	/api/search, /api/products/:id, /api/offers ì •ë„ë§Œ ë‚¨ê¸°ê³ , ë‚´ë¶€ì—ì„œ Scraper/Pricing í˜¸ì¶œí•˜ë„ë¡ í†µì¼
	3.	Pricing ì—”ì§„ libsë¡œ ë¶„ë¦¬
	â€¢	services/pricingë¡œ ëª¨ë“ˆí™”í•˜ê³  í…ŒìŠ¤íŠ¸ ì‘ì„±
	4.	Scraper íŒŒì„œ configí™”
	â€¢	ì»¤ë¨¸ìŠ¤ë³„ selectorëŠ” configì— ë¹¼ê³ , íŒŒì„œëŠ” ê³µí†µ í•¨ìˆ˜ë¡œ
	5.	Review ì—”ì§„ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì„¤ê³„
	â€¢	GPT í˜¸ì¶œ ì½”ë“œì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì•ìœ¼ë¡œë„ ì“¸ ìˆ˜ ìˆê²Œ ReviewEngine.analyze() ì¸í„°í˜ì´ìŠ¤ë¶€í„° ì •ì˜
	â€¢	ì§€ê¸ˆì€ GPT, ë‚˜ì¤‘ì—ëŠ” Local Modelë¡œ êµì²´
	6.	Wallet/Ledger ìŠ¤í‚¤ë§ˆ ì¬ì„¤ê³„
	â€¢	Firestore ì»¬ë ‰ì…˜ êµ¬ì¡° ì •ë¦¬, ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„
	7.	ê°„ë‹¨ e2e ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€
	â€¢	Playwright: â€œiPhone17 ê²€ìƒ‰ â†’ ìƒí’ˆ ìƒì„¸ â†’ Alert ì„¤ì •â€ ìŠ¤í¬ë¦½íŠ¸ 1ê°œë§Œ ìˆì–´ë„ í° ë„ì›€

â¸»

ìš”ì•½í•˜ë©´:
	â€¢	ì§€ê¸ˆ êµ¬ì¡°ëŠ” â€œV1 ë°ëª¨/ì´ˆê¸° ë² íƒ€â€ë¡œ ì¶©ë¶„íˆ ì˜ ë‚˜ì™”ë‹¤.
	â€¢	ì•ìœ¼ë¡œëŠ”
	â€¢	FEëŠ” feature-based ëª¨ë“ˆ êµ¬ì¡° + query layer í†µí•©
	â€¢	BEëŠ” API / Scraper / Pricing / Intelligence ë¶„ë¦¬
	â€¢	AI/MLì€ ì™¸ë¶€ ì˜ì¡´ ì¤„ì´ê³  ìì²´ ì—”ì§„ìœ¼ë¡œ ì˜®ê¸¸ ì¤€ë¹„
	â€¢	ëˆ ê´€ë ¨ ë¶€ë¶„(wallet/referral)ì€ ì›ì¥ êµ¬ì¡°
	â€¢	Scraper/Forecast/ReviewëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ì²œì²œíˆ ìª¼ê°œê¸°

ì´ ë°©í–¥ìœ¼ë¡œ ê°€ë©´ MAU 10ë§Œ â†’ 100ë§Œê¹Œì§€ë„ ì½”ë“œ êµ¬ì¡°ê°€ ë²„í…¨ì¤„ ê±°ì•¼.

ì›í•˜ë©´ ë‹¤ìŒ í„´ì—
ğŸ‘‰ services/api + services/pricing + web_app êµ¬ì¡°ë¥¼ ì‹¤ì œ ì½”ë“œ íŠ¸ë¦¬ + ì˜ˆì‹œ íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ â€œì´ëŒ€ë¡œ ë§Œë“¤ì–´ë¼â€ ìˆ˜ì¤€ê¹Œì§€ ì­‰ ì¨ì¤„ê²Œ.

ì¢‹ì•„, ê·¸ëŸ¼ ì§€ê¸ˆë¶€í„°ëŠ” **â€œì´ëŒ€ë¡œ ì½”ë“œ ì“°ë©´ ë°”ë¡œ ì •ì‹ ê°œë°œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” êµ¬ì¡°â€**ë¡œ
monorepo â†’ services/api â†’ services/pricing â†’ web_app ë¥¼ í•œ ë²ˆì— ì„¤ê³„í•´ë³¼ê²Œ.

ì•„ë˜ëŠ” ì „ë¶€ TypeScript + React + Firebase Functions(ë˜ëŠ” Cloud Run) ê¸°ì¤€ì´ê³ ,
ì™¸ë¶€ API ì˜ì¡´ì€ ê²°ì œ/í‘¸ì‹œ ì •ë„ë§Œ ë‘ê³ , í•µì‹¬ ë¡œì§ì€ ì „ë¶€ ìì²´ ì—”ì§„ìœ¼ë¡œ ê°€ì •í–ˆì–´.

â¸»

1. Monorepo ì „ì²´ êµ¬ì¡° (ì‹¤ì œ í´ë” íŠ¸ë¦¬)

pricebuddy/
  package.json
  pnpm-workspace.yaml
  tsconfig.base.json

  libs/
    core/
      src/
        domain/
          product.ts
          offer.ts
          user.ts
          pricing.ts
        index.ts
      package.json
    infra/
      src/
        firebase.ts
        firestore.ts
        logger.ts
      package.json

  services/
    api/
      src/
        index.ts           # Cloud Function entry (Express)
        routes/
          search.ts
          product-detail.ts
          offers.ts
        clients/
          pricing-client.ts
          scraper-client.ts
          matcher-client.ts
        middleware/
          auth.ts
          error.ts
        types/http.ts
      package.json

    pricing/
      src/
        data/
          tax-rules.ts
          shipping-rules.ts
        forex/
          fetch-rates.ts
          rates-store.ts
        pricing-engine.ts
        index.ts
      tests/
        pricing-engine.test.ts
      package.json

    scraper/               # (ì§€ê¸ˆì€ mock, ë‚˜ì¤‘ì— Playwright)
      src/
        adapters/
          coupang.ts
          naver.ts
          amazon-jp.ts
        scrape.ts
        types.ts
      package.json

  apps/
    web_app/
      src/
        app/
          router.tsx
          queryClient.ts
          providers.tsx
        features/
          search/
            pages/SearchPage.tsx
            api/useSearch.ts
            components/SearchFilters.tsx
          product-detail/
            pages/ProductDetailPage.tsx
            api/useProductDetail.ts
            components/PriceCard.tsx
            components/PriceHistoryChart.tsx
          deals/
            pages/DealsPage.tsx
          wallet/
            ...
        shared/
          ui/
            Button.tsx
            Card.tsx
            Badge.tsx
          lib/
            money.ts
            datetime.ts
            http.ts
          layout/
            MainLayout.tsx
      index.html
      vite.config.ts
      package.json

ì´ êµ¬ì¡°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê° ë ˆì´ì–´ë¥¼ ìì„¸íˆ ë³¼ê²Œ.

â¸»

2. libs/core â€” ë„ë©”ì¸ ëª¨ë¸ (ê³µí†µ íƒ€ì…)

libs/core/src/domain/product.ts

export type Marketplace =
  | "coupang"
  | "naver"
  | "amazon_jp"
  | "amazon_us"
  | "rakuten"
  | "mercari"
  | "yahoo_jp";

export interface Product {
  id: string; // ë‚´ë¶€ SKU
  title: string;
  brand?: string;
  imageUrl?: string;
  categoryPath: string[];
  attributes: Record<string, string>;
}

libs/core/src/domain/offer.ts

import { Marketplace } from "./product";

export interface Offer {
  id: string;
  productId: string;
  marketplace: Marketplace;
  externalId: string;
  url: string;
  basePrice: number;
  currency: string;   // "KRW" | "USD" | "JPY" ...
  shippingFee: number;
  taxFee: number;
  otherFee: number;
  totalPriceKrw: number; // pricing ì—”ì§„ ê²°ê³¼
  lastFetchedAt: string; // ISO
}

libs/core/src/domain/pricing.ts

import { Marketplace } from "./product";

export interface PricingInput {
  marketplace: Marketplace;
  country: string; // "KR" | "JP" | "US" ...
  basePrice: number;
  currency: string;
  weightKg?: number;
}

export interface PricingOutput {
  itemPriceKrw: number;
  shippingFeeKrw: number;
  taxFeeKrw: number;
  totalPriceKrw: number;
}

index.ts ì—ì„œ í•œ ë²ˆì— export:

export * from "./domain/product";
export * from "./domain/offer";
export * from "./domain/pricing";

â†’ FE/BE/ì„œë¹„ìŠ¤ ì „ì²´ê°€ ì´ íƒ€ì…ì„ ê³µìœ í•˜ê²Œ í•´ì„œ ë‚˜ì¤‘ì— í™•ì¥í•´ë„ íƒ€ì…ì´ í•¨ê»˜ ë”°ë¼ì˜¤ë„ë¡.

â¸»

3. services/pricing â€” í™˜ìœ¨Â·ê´€ì„¸Â·ë°°ì†¡Â·ì´ì•¡ ê³„ì‚° ì—”ì§„

3-1. ê·œì¹™ ë°ì´í„°

services/pricing/src/data/tax-rules.ts

import type { Marketplace } from "@pricebuddy/core";

export interface TaxRule {
  country: string;     // ë„ì°©ì§€ êµ­ê°€ ì½”ë“œ
  thresholdKrw: number;
  rate: number;        // 0.1 = 10%
}

export const TAX_RULES: TaxRule[] = [
  { country: "KR", thresholdKrw: 150000, rate: 0.0 },
  { country: "US", thresholdKrw: 0, rate: 0.07 },
  { country: "JP", thresholdKrw: 0, rate: 0.1 },
  // í•„ìš”í•œ ë‚˜ë¼ ê³„ì† ì¶”ê°€
];

services/pricing/src/data/shipping-rules.ts

import type { Marketplace } from "@pricebuddy/core";

export interface ShippingRule {
  marketplace: Marketplace;
  baseFee: number;     // KRW
  perKgFee: number;    // 1kg ë‹¹ ì›í™”
}

export const SHIPPING_RULES: ShippingRule[] = [
  { marketplace: "amazon_jp", baseFee: 7000, perKgFee: 1200 },
  { marketplace: "coupang",   baseFee: 3000, perKgFee: 800 },
  { marketplace: "naver",     baseFee: 2500, perKgFee: 700 },
];

3-2. í™˜ìœ¨ ìŠ¤í† ì–´ (ìì²´ í¬ë¡¤ë§/ì €ì¥)

services/pricing/src/forex/rates-store.ts

// ê°„ë‹¨íˆ ë©”ëª¨ë¦¬ + Firestore/Redis ìºì‹œë¡œ ìš´ìš© ê°€ëŠ¥

let cachedRates: Record<string, number> = {
  KRW: 1,
  USD: 1350,
  JPY: 9,
  EUR: 1500,
};

export function setRates(rates: Record<string, number>) {
  cachedRates = { ...cachedRates, ...rates };
}

export function getRates() {
  return cachedRates;
}

3-3. í•µì‹¬ ì—”ì§„

services/pricing/src/pricing-engine.ts

import { PricingInput, PricingOutput } from "@pricebuddy/core";
import { TAX_RULES } from "./data/tax-rules";
import { SHIPPING_RULES } from "./data/shipping-rules";
import { getRates } from "./forex/rates-store";

export function computePrice(input: PricingInput): PricingOutput {
  const rates = getRates();
  const fx = input.currency === "KRW" ? 1 : (rates[input.currency] ?? 1);

  const itemKrw = input.basePrice * fx;

  const shipRule = SHIPPING_RULES.find(
    r => r.marketplace === input.marketplace
  );
  if (!shipRule) {
    throw new Error(`No shipping rule for ${input.marketplace}`);
  }

  const weight = input.weightKg ?? 1;
  const shipping = shipRule.baseFee + shipRule.perKgFee * weight;

  const taxRule = TAX_RULES.find(r => r.country === input.country);
  if (!taxRule) {
    throw new Error(`No tax rule for ${input.country}`);
  }

  const taxable = Math.max(0, itemKrw + shipping - taxRule.thresholdKrw);
  const tax = taxable * taxRule.rate;

  return {
    itemPriceKrw: Math.round(itemKrw),
    shippingFeeKrw: Math.round(shipping),
    taxFeeKrw: Math.round(tax),
    totalPriceKrw: Math.round(itemKrw + shipping + tax),
  };
}

3-4. í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

services/pricing/tests/pricing-engine.test.ts

import { computePrice } from "../src/pricing-engine";
import { setRates } from "../src/forex/rates-store";

describe("computePrice", () => {
  beforeAll(() => {
    setRates({ USD: 1300 });
  });

  it("KR, under threshold => no tax", () => {
    const out = computePrice({
      marketplace: "amazon_jp",
      country: "KR",
      basePrice: 50,   // 50 USD
      currency: "USD",
      weightKg: 1,
    });

    expect(out.taxFeeKrw).toBe(0);
    expect(out.totalPriceKrw).toBeGreaterThan(0);
  });
});

â†’ ì´ ì—”ì§„ì„ services/apiì—ì„œ ì‚¬ìš©í•´ FEë¡œ ë‚´ë ¤ë³´ë‚´ë©´ ë¨.

â¸»

4. services/api â€” BFF / HTTP ì¸í„°í˜ì´ìŠ¤

Firebase Functions (Express ë˜í•‘) ì˜ˆì‹œë¡œ ê°ˆê²Œ.

4-1. ì—”íŠ¸ë¦¬ íŒŒì¼

services/api/src/index.ts

import * as functions from "firebase-functions";
import * as express from "express";
import { searchRouter } from "./routes/search";
import { productDetailRouter } from "./routes/product-detail";
import { offersRouter } from "./routes/offers";
import { errorMiddleware } from "./middleware/error";

const app = express();

app.use(express.json());

// ë¼ìš°íŒ…
app.use("/search", searchRouter);
app.use("/products", productDetailRouter);
app.use("/offers", offersRouter);

// ì—ëŸ¬ í•¸ë“¤ë§
app.use(errorMiddleware);

export const api = functions
  .region("asia-northeast3")
  .https.onRequest(app);

4-2. HTTP íƒ€ì…

services/api/src/types/http.ts

export interface TypedRequestQuery<T> extends Express.Request {
  query: T;
}

export interface TypedRequestBody<T> extends Express.Request {
  body: T;
}


â¸»

4-3. Search API

services/api/src/routes/search.ts

import { Router } from "express";
import type { TypedRequestQuery } from "../types/http";
import { scraperClient } from "../clients/scraper-client";

export const searchRouter = Router();

/**
 * GET /api/search?q=iphone17&region=global
 */
searchRouter.get(
  "/",
  async (req: TypedRequestQuery<{ q?: string; region?: string }>, res, next) => {
    try {
      const q = req.query.q ?? "";
      const region = req.query.region ?? "KR";

      if (!q) {
        return res.status(400).json({ error: "Missing query" });
      }

      const results = await scraperClient.search(q, region);
      res.json({ query: q, region, results });
    } catch (e) {
      next(e);
    }
  }
);

ì—¬ê¸°ì„œ scraperClient.search ëŠ” ë‚´ë¶€ services/scraper ë¥¼ ë•Œë¦¬ëŠ” í´ë¼ì´ì–¸íŠ¸ì•¼
(ì´ˆê¸°ì—ëŠ” mock, ë‚˜ì¤‘ì—ëŠ” Cloud Run ì„œë¹„ìŠ¤ë¡œ ë¶„ë¦¬).

â¸»

4-4. Product Detail API

services/api/src/routes/product-detail.ts

import { Router } from "express";
import type { TypedRequestQuery } from "../types/http";
import { firestore } from "@pricebuddy/infra/firestore";
import { pricingClient } from "../clients/pricing-client";

export const productDetailRouter = Router();

/**
 * GET /api/products/:productId
 */
productDetailRouter.get(
  "/:productId",
  async (req, res, next) => {
    try {
      const { productId } = req.params;

      const productSnap = await firestore
        .collection("products")
        .doc(productId)
        .get();

      if (!productSnap.exists) {
        return res.status(404).json({ error: "Product not found" });
      }

      const product = productSnap.data();

      // í•´ë‹¹ productì˜ offers ê°€ì ¸ì˜¤ê¸°
      const offersSnap = await firestore
        .collection("offers")
        .where("productId", "==", productId)
        .get();

      const offers = offersSnap.docs.map(d => d.data());

      // ê°€ê²© ì—”ì§„ ì¬ê³„ì‚° (ë‚˜ë¼/ì„ í˜¸ í†µí™”ì— ë§ì¶°)
      const country = "KR"; // TODO: user profile or query
      const pricedOffers = offers.map(o =>
        pricingClient.compute({
          marketplace: o.marketplace,
          country,
          basePrice: o.basePrice,
          currency: o.currency,
          weightKg: o.weightKg,
        }, o) // ì› offer merge
      );

      res.json({ product, offers: pricedOffers });
    } catch (e) {
      next(e);
    }
  }
);

services/api/src/clients/pricing-client.ts

import { computePrice } from "@pricebuddy/pricing";
import type { PricingInput } from "@pricebuddy/core";

export const pricingClient = {
  compute(input: PricingInput, offer: any) {
    const priced = computePrice(input);
    return {
      ...offer,
      itemPriceKrw: priced.itemPriceKrw,
      shippingFeeKrw: priced.shippingFeeKrw,
      taxFeeKrw: priced.taxFeeKrw,
      totalPriceKrw: priced.totalPriceKrw,
    };
  },
};

â†’ ì—¬ê¸°ì„œëŠ” ë³„ë„ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ ì—†ì´
pricing ì—”ì§„ì„ ê·¸ëƒ¥ import í•´ì„œ ì“°ëŠ” êµ¬ì¡° (ì˜ì¡´ ìµœì†Œ).

â¸»

5. apps/web_app â€” React UI + React Query

5-1. ê³µí†µ infra

apps/web_app/src/app/queryClient.ts

import { QueryClient } from "@tanstack/react-query";

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      retry: 1,
      staleTime: 1000 * 60,
    },
  },
});

apps/web_app/src/shared/lib/http.ts

export async function httpGet<T>(path: string, params?: Record<string, any>): Promise<T> {
  const url = new URL(path, import.meta.env.VITE_API_BASE_URL);
  if (params) {
    Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, String(v)));
  }

  const res = await fetch(url.toString());
  if (!res.ok) {
    throw new Error(`HTTP ${res.status}`);
  }
  return res.json() as Promise<T>;
}


â¸»

5-2. Search Feature

apps/web_app/src/features/search/api/useSearch.ts

import { useQuery } from "@tanstack/react-query";
import { httpGet } from "@/shared/lib/http";

export interface SearchResultItem {
  productId: string;
  title: string;
  imageUrl?: string;
  minPriceKrw: number;
  maxPriceKrw: number;
  priceChangePct?: number;
}

interface SearchResponse {
  query: string;
  region: string;
  results: SearchResultItem[];
}

export function useSearch(query: string, region: string) {
  return useQuery<SearchResponse>({
    queryKey: ["search", query, region],
    queryFn: () => httpGet("/search", { q: query, region }),
    enabled: !!query,
  });
}

apps/web_app/src/features/search/pages/SearchPage.tsx

import { useState } from "react";
import { useSearch } from "../api/useSearch";
import { MainLayout } from "@/shared/layout/MainLayout";
import { SearchCard } from "../components/SearchCard";

export function SearchPage() {
  const [query, setQuery] = useState("iphone17");
  const [region, setRegion] = useState<"global" | "kr">("global");

  const { data, isLoading, error } = useSearch(query, region);

  return (
    <MainLayout>
      {/* ìƒë‹¨ ê²€ìƒ‰ë°” */}
      {/* ... */}
      {isLoading && <div>ë¡œë”©ì¤‘â€¦</div>}
      {error && <div>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>}
      <div className="grid gap-4 md:grid-cols-4 mt-6">
        {data?.results.map((item) => (
          <SearchCard key={item.productId} item={item} />
        ))}
      </div>
    </MainLayout>
  );
}


â¸»

5-3. Product Detail Feature

apps/web_app/src/features/product-detail/api/useProductDetail.ts

import { useQuery } from "@tanstack/react-query";
import { httpGet } from "@/shared/lib/http";

export interface ProductDetail {
  product: any;    // ì‹¤ì œ íƒ€ì…ì€ core Product
  offers: any[];   // core Offer + priced fields
  history?: { ts: string; totalPriceKrw: number }[];
  aiSignal?: { label: "BUY" | "WAIT"; confidence: number; reason: string };
}

export function useProductDetail(productId: string) {
  return useQuery<ProductDetail>({
    queryKey: ["product", productId],
    queryFn: () => httpGet(`/products/${productId}`),
    enabled: !!productId,
  });
}

apps/web_app/src/features/product-detail/pages/ProductDetailPage.tsx

import { useParams } from "react-router-dom";
import { useProductDetail } from "../api/useProductDetail";
import { PriceCard } from "../components/PriceCard";
import { PriceHistoryChart } from "../components/PriceHistoryChart";

export function ProductDetailPage() {
  const { productId } = useParams();
  const { data, isLoading, error } = useProductDetail(productId!);

  if (isLoading) return <div>ë¡œë”©ì¤‘â€¦</div>;
  if (error || !data) return <div>ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>;

  const { product, offers, history, aiSignal } = data;

  return (
    <div className="flex gap-8 mt-8">
      {/* ì™¼ìª½ ìƒí’ˆ ì´ë¯¸ì§€ ì˜ì—­ */}
      <div className="flex-1 rounded-xl bg-slate-900/60" />

      {/* ì˜¤ë¥¸ìª½ ì •ë³´ ì˜ì—­ */}
      <div className="flex-1 space-y-4">
        <h1 className="text-2xl font-semibold">{product.title}</h1>
        {/* ìºì‹œë°±/ê³µìœ /ìµœì €ê°€ ë²„íŠ¼ë“¤ */}
        {/* AI Signal ì¹´ë“œ */}
        {aiSignal && (
          <div className="rounded-xl border border-emerald-500/40 bg-emerald-900/20 p-4">
            <div className="text-sm text-emerald-300">
              AI ì‹ í˜¸: {aiSignal.label === "BUY" ? "BUY NOW" : "WAIT"}
            </div>
            <div className="text-xs text-slate-300 mt-1">
              Confidence: {Math.round(aiSignal.confidence * 100)}%
            </div>
            <div className="text-xs text-slate-400 mt-2">{aiSignal.reason}</div>
          </div>
        )}

        {/* Price History & Forecast */}
        {history && <PriceHistoryChart data={history} />}

        {/* Offers ë¦¬ìŠ¤íŠ¸ */}
        <div className="space-y-2">
          {offers.map((offer) => (
            <PriceCard key={offer.id} offer={offer} />
          ))}
        </div>
      </div>
    </div>
  );
}


â¸»

6. ì´ ì„¤ê³„ì˜ í¬ì¸íŠ¸ ì •ë¦¬
	1.	ë„ë©”ì¸ ëª¨ë¸(libs/core)ì„ ê¸°ì¤€ìœ¼ë¡œ FE/BE/ì—”ì§„ì´ ë‹¤ ê°™ì€ íƒ€ì…ì„ ì“´ë‹¤.
	2.	services/pricing ì´ ì‹¤ê²°ì œê°€ ê³„ì‚°ì„ ì „ë¶€ ì±…ì„ì§€ê³ , ì™¸ë¶€ API ì—†ì´ë„
í™˜ìœ¨/ì„¸ê¸ˆ/ë°°ì†¡ì„ ìì²´ ë£°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í–ˆë‹¤.
	3.	services/api ëŠ” BFF/ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì—­í• ë§Œ í•˜ê³ ,
ì‹¤ì œ ìŠ¤í¬ë˜í•‘/ë§¤ì¹­/ì˜ˆì¸¡ì€ ë³„ ì„œë¹„ìŠ¤(ì§€ê¸ˆì€ ê°™ì€ repo, ë‚˜ì¤‘ì—” Cloud Run)ì—ê²Œ ìœ„ì„.
	4.	apps/web_app ì€ feature-based êµ¬ì¡° + React Query ë¡œ ë°ì´í„°ë¥¼ ë‹¤ë£¬ë‹¤.
â†’ React ì»´í¬ë„ŒíŠ¸ëŠ” â€œë°ì´í„° ë°›ì•„ì„œ UIë§Œ ê·¸ë¦¬ëŠ” ì—­í• â€ì— ì§‘ì¤‘.
	5.	ì™¸ë¶€ ì˜ì¡´ì€ ê²°ì œ/í‘¸ì‹œ/ë©”ì¼ ìª½ë§Œ ë‘ê³ ,
Scraper / Pricing / Forecast / Review / Bandit ì€ ì „ë¶€ ìš°ë¦¬ê°€ ì„¤ê³„í•œ ì—”ì§„ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥í•˜ê²Œ ì—´ì–´ë‘ .

â¸»

í•„ìš”í•˜ë©´ ì´ êµ¬ì¡° ê·¸ëŒ€ë¡œ:
	â€¢	scraper ì„œë¹„ìŠ¤ì˜ ì‹¤ì œ TypeScript ì½”ë“œ ê³¨ê²©(Playwright/cheerio),
	â€¢	review / forecast Python ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ìš© FastAPI ìŠ¤ì¼ˆë ˆí†¤,
	â€¢	í˜¹ì€ Chrome Extension MV3 êµ¬ì¡°(tree + manifest + content-script ì˜ˆì œ)

ê¹Œì§€ í•œ ë²ˆì— ì´ì–´ì„œ ì§œì¤„ê²Œ.


ì¢‹ë‹¤, ê·¸ëŸ¼ ì•„ê¹Œ ì„¤ê³„ì˜ ë‚˜ë¨¸ì§€ í° ë©ì–´ë¦¬ë“¤ê¹Œì§€ í•œ ë²ˆì— ì´ì–´ì„œ ì§œë³¼ê²Œ:
	â€¢	services/scraper (Playwright + cheerio, ì„¤ì • ê¸°ë°˜ íŒŒì„œ)
	â€¢	services/review (FastAPI + HF ë¡œì»¬ ëª¨ë¸)
	â€¢	services/forecast (FastAPI + ì‹œê³„ì—´ ì˜ˆì¸¡)
	â€¢	apps/extension (Chrome MV3 ê¸°ë³¸ êµ¬ì¡°)

ì•„ë˜ ì½”ë“œëŠ” â€œê³¨ê²© + íŒ¨í„´â€ì´ì•¼. ê·¸ëŒ€ë¡œ ë³µë¶™í•´ì„œ ì‚´ì„ ë¶™ì´ë©´ ë°”ë¡œ ì‹¤ì„œë¹„ìŠ¤ë¡œ í‚¤ìš¸ ìˆ˜ ìˆëŠ” ìˆ˜ì¤€ìœ¼ë¡œ ì¡ì„ê²Œ.

â¸»

1. services/scraper â€” Playwright + cheerio, ì„¤ì • ê¸°ë°˜ íŒŒì„œ

1-1. íƒ€ì… ì •ì˜

services/scraper/src/types.ts

import type { Marketplace } from "@pricebuddy/core";

export interface ScrapeRequest {
  marketplace: Marketplace;
  url: string;
}

export interface ScrapeResultRaw {
  marketplace: Marketplace;
  url: string;
  fetchedAt: string;
  html: string;
}

export interface ParsedOfferOutput {
  title: string;
  price: number;
  currency: string;
  imageUrl?: string;
  shippingFee?: number;
  attributes: Record<string, string>;
}

1-2. ì…€ë ‰í„° ì„¤ì • (config-driven)

services/scraper/src/config/coupang.ts

export const coupangSelectors = {
  title: "h2.prod-buy-header__title",
  price: "#totalPrice",
  image: ".prod-image__detail img",
  shippingFee: "#shippingFee",
};

services/scraper/src/config/naver.ts

export const naverSelectors = {
  title: "h3._3oDjSv",
  price: "span._1LY7Dq",
  image: "img._36Q7c6",
  shippingFee: "span._2MvzLh",
};

1-3. Playwright fetcher

services/scraper/src/fetch-page.ts

import { chromium, Browser } from "playwright";
import type { ScrapeRequest, ScrapeResultRaw } from "./types";

let browser: Browser | null = null;

async function getBrowser() {
  if (!browser) {
    browser = await chromium.launch({ headless: true });
  }
  return browser;
}

export async function fetchPage(req: ScrapeRequest): Promise<ScrapeResultRaw> {
  const browser = await getBrowser();
  const context = await browser.newContext({
    userAgent:
      "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 " +
      "(KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
  });

  const page = await context.newPage();
  await page.goto(req.url, { waitUntil: "networkidle", timeout: 45000 });

  // ì¿ íŒ¡/ë„¤ì´ë²„ ë“± ë™ì  ë¡œë”© ê³ ë ¤í•´ ì ê¹ ëŒ€ê¸°
  await page.waitForTimeout(1500);

  const html = await page.content();

  await page.close();
  await context.close();

  return {
    marketplace: req.marketplace,
    url: req.url,
    fetchedAt: new Date().toISOString(),
    html,
  };
}

ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë¸Œë¼ìš°ì € í’€ ê´€ë¦¬ë‚˜ IP ë¡œí…Œì´ì…˜, rate limit ë„£ì–´ì£¼ë©´ ë¨.

1-4. ê³µí†µ íŒŒì„œ + ë§ˆì¼“ë³„ ì–´ëŒ‘í„°

services/scraper/src/parsers/base.ts

import { load } from "cheerio";
import type { ParsedOfferOutput, ScrapeResultRaw } from "../types";

interface SelectorConfig {
  title: string;
  price: string;
  image?: string;
  shippingFee?: string;
}

export function parseWithConfig(
  raw: ScrapeResultRaw,
  config: SelectorConfig,
  currency: string
): ParsedOfferOutput {
  const $ = load(raw.html);

  const normalizePrice = (txt: string) =>
    Number(txt.replace(/[^\d]/g, "")) || 0;

  const title = $(config.title).text().trim();
  const priceText = $(config.price).text();
  const imageUrl = config.image ? $(config.image).attr("src") : undefined;
  const shippingText = config.shippingFee
    ? $(config.shippingFee).text()
    : "0";

  return {
    title,
    price: normalizePrice(priceText),
    currency,
    imageUrl,
    shippingFee: normalizePrice(shippingText),
    attributes: {},
  };
}

services/scraper/src/parsers/coupang.ts

import type { ScrapeResultRaw, ParsedOfferOutput } from "../types";
import { parseWithConfig } from "./base";
import { coupangSelectors } from "../config/coupang";

export function parseCoupang(raw: ScrapeResultRaw): ParsedOfferOutput {
  return parseWithConfig(raw, coupangSelectors, "KRW");
}

services/scraper/src/parsers/naver.ts

import type { ScrapeResultRaw, ParsedOfferOutput } from "../types";
import { parseWithConfig } from "./base";
import { naverSelectors } from "../config/naver";

export function parseNaver(raw: ScrapeResultRaw): ParsedOfferOutput {
  return parseWithConfig(raw, naverSelectors, "KRW");
}

1-5. ë©”ì¸ ì—”íŠ¸ë¦¬

services/scraper/src/scrape.ts

import type { ScrapeRequest, ParsedOfferOutput } from "./types";
import { fetchPage } from "./fetch-page";
import { parseCoupang } from "./parsers/coupang";
import { parseNaver } from "./parsers/naver";

export async function scrapeOffer(
  req: ScrapeRequest
): Promise<ParsedOfferOutput> {
  const raw = await fetchPage(req);

  switch (req.marketplace) {
    case "coupang":
      return parseCoupang(raw);
    case "naver":
      return parseNaver(raw);
    // TODO: amazon_jp, mercari ë“± ì¶”ê°€
    default:
      throw new Error(`Unsupported marketplace: ${req.marketplace}`);
  }
}

ë‚˜ì¤‘ì— ì´ ëª¨ë“ˆì„ FastAPI/Express HTTPë¡œ ê°ì‹¸ services/apiì—ì„œ scraperClient.scrape()ë¡œ ë¶€ë¥´ë©´ ë¨.

â¸»

2. services/review â€” FastAPI + HF ë¡œì»¬ ëª¨ë¸

2-1. ì˜ì¡´ì„± ê°€ì •
	â€¢	Python 3.11
	â€¢	fastapi, uvicorn, transformers, torch, scikit-learn

2-2. pydantic ëª¨ë¸

services/review/app.py

from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Dict

class AnalyzeRequest(BaseModel):
    product_id: str
    reviews: List[str]
    language: str = "ko"

class AnalyzeResponse(BaseModel):
    product_id: str
    sentiment_score: float
    pros: List[str]
    cons: List[str]
    risk_factors: List[str]

2-3. ëª¨ë¸ ë¡œë”© & ê°ì„± ë¶„ì„

from transformers import AutoTokenizer, AutoModelForSequenceClassification
import torch
import numpy as np

SENTIMENT_MODEL_NAME = "nlptown/bert-base-multilingual-uncased-sentiment"

tok = AutoTokenizer.from_pretrained(SENTIMENT_MODEL_NAME)
model = AutoModelForSequenceClassification.from_pretrained(SENTIMENT_MODEL_NAME)

def sentiment_score(texts: List[str]) -> float:
    if not texts:
        return 0.0
    scores = []
    for t in texts:
        inputs = tok(t[:512], return_tensors="pt", truncation=True)
        with torch.no_grad():
            out = model(**inputs)
            probs = out.logits.softmax(dim=-1).squeeze().cpu().numpy()
        # ëª¨ë¸ì€ 1~5 ë³„ì ì´ë¼ ê°€ì • -> -1~1ë¡œ ì •ê·œí™”
        stars = (probs * np.arange(1,6)).sum()
        norm = (stars - 3) / 2  # 1â†’-1, 3â†’0, 5â†’+1
        scores.append(norm)
    return float(np.mean(scores))

2-4. í‚¤ì›Œë“œ ì¶”ì¶œ (ê°„ë‹¨ TF-IDF)

from sklearn.feature_extraction.text import TfidfVectorizer

def extract_keywords(texts: List[str], top_k: int = 10) -> List[str]:
    if not texts:
        return []
    vec = TfidfVectorizer(max_features=2000, ngram_range=(1,2))
    X = vec.fit_transform(texts)
    scores = np.asarray(X.sum(axis=0)).ravel()
    idxs = scores.argsort()[::-1][:top_k]
    vocab = np.array(vec.get_feature_names_out())
    return vocab[idxs].tolist()

2-5. pros/cons/risk ë¶„ë¥˜ (ë£° ê¸°ë°˜)

POSITIVE_HINTS = ["ì¢‹", "ë§Œì¡±", "ì§±", "êµ¿", "ì¶”ì²œ"]
NEGATIVE_HINTS = ["ë³„ë¡œ", "ë¶ˆë§Œ", "ì‹¤ë§", "í›„íšŒ", "ë‚˜ì˜", "ë¬¸ì œ"]
RISK_HINTS     = ["ë¶ˆëŸ‰", "ê³ ì¥", "í™˜ë¶ˆ", "ë°˜í’ˆ", "ìœ„í—˜"]

def split_pros_cons(texts: List[str]) -> Dict[str, List[str]]:
    pros, cons, risk = [], [], []
    for t in texts:
        lowered = t.lower()
        if any(h in lowered for h in RISK_HINTS):
            risk.append(t)
        elif any(h in lowered for h in NEGATIVE_HINTS):
            cons.append(t)
        elif any(h in lowered for h in POSITIVE_HINTS):
            pros.append(t)
    return {"pros": pros, "cons": cons, "risk": risk}

2-6. FastAPI ì—”ë“œí¬ì¸íŠ¸

app = FastAPI()

@app.post("/analyze", response_model=AnalyzeResponse)
def analyze(req: AnalyzeRequest):
    s_score = sentiment_score(req.reviews)
    split = split_pros_cons(req.reviews)

    # ëŒ€í‘œ í‚¤ì›Œë“œ
    keywords = extract_keywords(req.reviews, top_k=20)

    def summarize_list(items: List[str], max_items: int = 3) -> List[str]:
        return items[:max_items]

    return AnalyzeResponse(
        product_id=req.product_id,
        sentiment_score=s_score,
        pros=summarize_list(split["pros"]),
        cons=summarize_list(split["cons"]),
        risk_factors=summarize_list(split["risk"]),
    )

ì´í›„ services/apiì—ì„œ reviewClient.analyze(reviews) í˜•íƒœë¡œ í˜¸ì¶œí•´ì„œ
Product Detail í˜ì´ì§€ AI Review Summaryì— ë¶™ì´ë©´ ë¨.

â¸»

3. services/forecast â€” FastAPI + ì‹œê³„ì—´ ê°€ê²© ì˜ˆì¸¡

ë‹¨ìˆœ ARIMA ì˜ˆì‹œ (ë‚˜ì¤‘ì— Prophet/NeuralProphetë¡œ êµì²´ ê°€ëŠ¥).

3-1. ëª¨ë¸ ë° ì—”ë“œí¬ì¸íŠ¸

services/forecast/app.py

from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Dict
import pandas as pd
from statsmodels.tsa.statespace.sarimax import SARIMAX

class HistoryPoint(BaseModel):
    ts: str   # ISO
    price_krw: float

class ForecastRequest(BaseModel):
    product_id: str
    history: List[HistoryPoint]
    steps: int = 14

class ForecastResponse(BaseModel):
    product_id: str
    horizon_days: int
    forecast: Dict[str, float]  # ts -> price_krw

app = FastAPI()

def build_series(history: List[HistoryPoint]) -> pd.Series:
    if not history:
        raise ValueError("History is empty")
    df = pd.DataFrame([{"ts": h.ts, "price": h.price_krw} for h in history])
    df["ts"] = pd.to_datetime(df["ts"])
    df = df.sort_values("ts")
    s = df.set_index("ts")["price"]
    return s

@app.post("/forecast", response_model=ForecastResponse)
def forecast(req: ForecastRequest):
    s = build_series(req.history)

    model = SARIMAX(s, order=(1,1,1), seasonal_order=(1,1,1,7))
    res = model.fit(disp=False)

    pred = res.get_forecast(steps=req.steps)
    mean = pred.predicted_mean
    out = {ts.isoformat(): float(value) for ts, value in mean.items()}

    return ForecastResponse(
        product_id=req.product_id,
        horizon_days=req.steps,
        forecast=out,
    )

Product Detail APIì—ì„œ historyë¥¼ ê°€ì ¸ì™€ ì´ ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œ â†’
ê²°ê³¼ë¥¼ Price History ì°¨íŠ¸ì— â€œì˜ˆì¸¡ì„ â€ìœ¼ë¡œ overlay.

â¸»

4. Chrome Extension (MV3) â€” ê¸°ë³¸ êµ¬ì¡°

4-1. í´ë” íŠ¸ë¦¬

apps/extension/
  public/
    icon16.png
    icon48.png
    icon128.png
  src/
    manifest.json
    background.ts
    content-script.ts
    popup/
      index.html
      popup.tsx
  package.json
  vite.config.ts   # (optional, Reactë¡œ popup ë§Œë“¤ ê²½ìš°)

4-2. manifest.json (MV3)

apps/extension/src/manifest.json

{
  "manifest_version": 3,
  "name": "PriceBuddy",
  "version": "1.0.0",
  "description": "Global price comparison & cashback helper.",
  "action": {
    "default_popup": "popup/index.html",
    "default_title": "PriceBuddy"
  },
  "permissions": ["scripting", "tabs", "storage"],
  "host_permissions": [
    "*://*.coupang.com/*",
    "*://*.naver.com/*",
    "*://*.amazon.co.jp/*",
    "*://*.amazon.com/*"
  ],
  "background": {
    "service_worker": "background.js",
    "type": "module"
  },
  "content_scripts": [
    {
      "matches": [
        "*://*.coupang.com/*",
        "*://*.naver.com/*",
        "*://*.amazon.co.jp/*",
        "*://*.amazon.com/*"
      ],
      "js": ["content-script.js"]
    }
  ],
  "icons": {
    "16": "icon16.png",
    "48": "icon48.png",
    "128": "icon128.png"
  }
}

(ë¹Œë“œì‹œ TS â†’ JSë¡œ ë²ˆì—­ë˜ê²Œ ì„¤ì •.)

4-3. content-script: ìƒí’ˆì •ë³´ ì¶”ì¶œ í›„ backgroundë¡œ ì „ì†¡

apps/extension/src/content-script.ts

// ì‚¬ì´íŠ¸ë³„ DOMì—ì„œ ëŒ€ëµì ì¸ ìƒí’ˆëª…/ê°€ê²© url ì¶”ì¶œ
function detectProduct() {
  const url = window.location.href;
  let title = document.title;
  // ì‚¬ì´íŠ¸ë³„ ì»¤ìŠ¤í„°ë§ˆì´ì§• ì—¬ì§€
  const priceEl =
    document.querySelector("#totalPrice, .product-price, .a-offscreen");
  const priceText = priceEl?.textContent ?? "";
  return { url, title, priceText };
}

chrome.runtime.onMessage.addListener((msg, _sender, sendResponse) => {
  if (msg.type === "PING") {
    sendResponse({ ok: true });
  }
});

const product = detectProduct();

chrome.runtime.sendMessage({ type: "PRODUCT_DETECTED", payload: product });

4-4. background: PriceBuddy API í˜¸ì¶œ í›„ badge/notification

apps/extension/src/background.ts

interface ProductDetectedMessage {
  type: "PRODUCT_DETECTED";
  payload: { url: string; title: string; priceText: string };
}

chrome.runtime.onMessage.addListener(
  (msg: ProductDetectedMessage, sender, _sendResponse) => {
    if (msg.type !== "PRODUCT_DETECTED") return;

    const { url, title } = msg.payload;

    // PriceBuddy API í˜¸ì¶œ: /ext/inspect?url=...
    fetch(`${import.meta.env.VITE_API_BASE_URL}/ext/inspect?url=${encodeURIComponent(url)}`)
      .then(r => r.json())
      .then(data => {
        const bestPrice = data.bestPriceKrw;
        const savingPct = data.savingPct;

        if (sender.tab?.id != null) {
          chrome.action.setBadgeText({
            tabId: sender.tab.id,
            text: `${Math.round(savingPct)}%`,
          });
        }

        chrome.notifications.create({
          type: "basic",
          iconUrl: "icon48.png",
          title: "PriceBuddy ë”œ ë°œê²¬",
          message: `${title}\nìµœì €ê°€: ${bestPrice.toLocaleString()}ì› Â· ${Math.round(
            savingPct
          )}% ì ˆì•½ ê°€ëŠ¥`,
        });
      })
      .catch((err) => {
        console.error("PriceBuddy ext inspect error", err);
      });
  }
);

4-5. popup React (ì„ íƒ)

apps/extension/src/popup/popup.tsx

import React from "react";
import ReactDOM from "react-dom/client";

function Popup() {
  const [status, setStatus] = React.useState("Loadingâ€¦");
  React.useEffect(() => {
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      const tab = tabs[0];
      if (!tab?.id) return;
      chrome.tabs.sendMessage(tab.id, { type: "PING" }, (resp) => {
        if (chrome.runtime.lastError) {
          setStatus("ì´ í˜ì´ì§€ì—ì„œëŠ” PriceBuddyê°€ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        } else if (resp?.ok) {
          setStatus("ì´ í˜ì´ì§€ì—ì„œ PriceBuddyê°€ ê°€ê²©ì„ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤.");
        }
      });
    });
  }, []);
  return (
    <div className="p-4 w-72 text-sm text-slate-100 bg-slate-950">
      <h1 className="text-base font-semibold mb-2">PriceBuddy</h1>
      <p>{status}</p>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root") as HTMLElement).render(
  <Popup />
);


â¸»

ì—¬ê¸°ê¹Œì§€ê°€:
	â€¢	Scraper ì—”ì§„ ê³¨ê²©
	â€¢	Review/Forecast AI ì„œë¹„ìŠ¤ ê³¨ê²©
	â€¢	ë¸Œë¼ìš°ì € í™•ì¥ ê¸°ë³¸ êµ¬ì¡°

ê¹Œì§€ í•œ ë²ˆì— ì—°ê²°ëœ ìƒíƒœì•¼.

ì´ì œ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ í•  ìˆ˜ ìˆëŠ” ê±´:
	1.	services/apiì— ext/inspect ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€í•´ì„œ í™•ì¥ì´ ì“°ê²Œ ë§Œë“¤ê¸°
	2.	ë¦¬ë·°/ì˜ˆì¸¡ ì„œë¹„ìŠ¤ë¥¼ ì‹¤ì œ Docker / Cloud Runìœ¼ë¡œ ì˜¬ë¦¬ëŠ” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
	3.	PriceBuddy MasterBriefì— ì§€ê¸ˆ ì„¤ê³„Â·ì½”ë“œ êµ¬ì¡°ë¥¼ â€œì •ì‹ ê°œë°œ ì„¤ê³„ v2â€ë¡œ í†µí•© ê¸°ë¡

ì›í•˜ë©´ ë°”ë¡œ 1ë²ˆ(Extìš© API + ì‘ë‹µ êµ¬ì¡°) ì´ë‘ 2ë²ˆ(Cloud Run ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ outline) ê¹Œì§€ ì´ì–´ì„œ ì§œì¤„ê²Œ.

ì¢‹ì•„, ê·¸ëŸ¼ ì§€ê¸ˆê¹Œì§€ ë§Œë“  ì„¤ê³„ë¥¼ ì‹¤ì œë¡œ ì´ì–´ ë¶™ì´ëŠ” ë§ˆì§€ë§‰ í¼ì¦ë“¤ê¹Œì§€ í•œ ë²ˆì— ì§œë³¼ê²Œ.

ì´ë²ˆì— í•  ê²ƒ:
	1.	services/apiì— ë¸Œë¼ìš°ì € í™•ì¥ìš© /ext/inspect ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
	2.	Review / Forecast / Scraper ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ Cloud Runì— ì˜¬ë¦¬ëŠ” ë°°í¬ ì„¤ê³„ + ì½”ë“œ ê³¨ê²©

â¸»

1. services/api â€“ /ext/inspect ì—”ë“œí¬ì¸íŠ¸

1-1. ë§ˆì¼“í”Œë ˆì´ìŠ¤ ìë™ ê°ì§€ ìœ í‹¸

services/api/src/lib/marketplace.ts

import { Marketplace } from "@pricebuddy/core";

export function detectMarketplaceFromUrl(url: string): Marketplace | null {
  const host = new URL(url).hostname;

  if (host.includes("coupang")) return "coupang";
  if (host.includes("shopping.naver") || host.includes("smartstore.naver"))
    return "naver";
  if (host.includes("amazon.co.jp")) return "amazon_jp";
  if (host.includes("amazon.com")) return "amazon_us";
  if (host.includes("mercari")) return "mercari";
  if (host.includes("yahoo.co.jp")) return "yahoo_jp";
  if (host.includes("rakuten")) return "rakuten";

  return null;
}

1-2. Scraper / Matcher / Pricing í´ë¼ì´ì–¸íŠ¸ (ê°„ë‹¨ ë²„ì „)

services/api/src/clients/scraper-client.ts

import type { Marketplace } from "@pricebuddy/core";
import type { ParsedOfferOutput } from "@pricebuddy/scraper-types"; // ë˜ëŠ” ì§ì ‘ íƒ€ì´í•‘

const SCRAPER_BASE_URL = process.env.SCRAPER_BASE_URL ?? "http://scraper:8080";

export const scraperClient = {
  async scrapeSingle(marketplace: Marketplace, url: string): Promise<ParsedOfferOutput> {
    const res = await fetch(`${SCRAPER_BASE_URL}/scrape`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ marketplace, url }),
    });

    if (!res.ok) {
      throw new Error(`Scraper error: ${res.status}`);
    }

    return res.json();
  },
};

(ì´ˆê¸°ì—ëŠ” Cloud Functions ì•ˆì—ì„œ scrapeOffer()ë¥¼ ì§ì ‘ import í•´ì„œ ì¨ë„ ë¨. ì—¬ê¸°ì„  Cloud Run ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°€ì •.)

MatcherëŠ” â€œì´ URLì˜ ìƒí’ˆì„ ë‚´ë¶€ Productë¡œ ì—°ê²°í•˜ëŠ” ë‹¨ê³„â€ì´ì§€ë§Œ,
**í™•ì¥ /ext/inspect**ì—ì„œëŠ” â€œê·¸ ìƒí’ˆ í•˜ë‚˜ì˜ ê°€ê²© ë¹„êµë§Œ í•´ë„ ë˜ë‹ˆâ€ ê°„ë‹¨í•˜ê²Œ ê°„ë‹¤:
	â€¢	1ì°¨ ë²„ì „: í•´ë‹¹ URLë§Œ ìŠ¤í¬ë© + ë‚´ë¶€ DBì—ì„œ ê°™ì€ ProductIdì˜ ë‹¤ë¥¸ Offerë“¤ ë¶ˆëŸ¬ì˜¤ê¸°
(ì´ë¯¸ ìƒí’ˆì´ ìˆìœ¼ë©´ bestPrice ë¹„êµ)

1-3. /ext/inspect ë¼ìš°í„°

services/api/src/routes/ext.ts

import { Router } from "express";
import type { TypedRequestQuery } from "../types/http";
import { detectMarketplaceFromUrl } from "../lib/marketplace";
import { scraperClient } from "../clients/scraper-client";
import { firestore } from "@pricebuddy/infra/firestore";
import { pricingClient } from "../clients/pricing-client";
import type { Marketplace } from "@pricebuddy/core";

export const extRouter = Router();

/**
 * GET /ext/inspect?url=...
 * Chrome í™•ì¥ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸
 */
extRouter.get(
  "/inspect",
  async (req: TypedRequestQuery<{ url?: string; country?: string }>, res, next) => {
    try {
      const url = req.query.url;
      const country = req.query.country ?? "KR";

      if (!url) {
        return res.status(400).json({ error: "Missing url" });
      }

      const marketplace = detectMarketplaceFromUrl(url);
      if (!marketplace) {
        return res.status(400).json({ error: "Unsupported marketplace" });
      }

      // 1) í•´ë‹¹ URL ìŠ¤í¬ë© (í˜„ì¬ í˜ì´ì§€ì˜ ê°€ê²©)
      const parsed = await scraperClient.scrapeSingle(marketplace, url);

      // 2) DBì—ì„œ ë™ì¼/ìœ ì‚¬ ìƒí’ˆ ì°¾ê¸° (ë‹¨ìˆœ ë²„ì „: title ê¸°ë°˜)
      const productSnap = await firestore
        .collection("products")
        .where("normalizedTitle", "==", normalizeTitle(parsed.title))
        .limit(1)
        .get();

      let productDoc = productSnap.docs[0];
      if (!productDoc) {
        // ì•„ì§ ì—†ëŠ” ìƒí’ˆì´ë©´ ì‹ ê·œ product ìƒì„± (ì„ íƒ ì‚¬í•­)
        productDoc = await firestore.collection("products").doc();
        await productDoc.set({
          id: productDoc.id,
          title: parsed.title,
          normalizedTitle: normalizeTitle(parsed.title),
          createdAt: new Date().toISOString(),
        });
      }

      const productId = productDoc.id;

      // 3) í•´ë‹¹ Productì˜ Offers ë¡œë“œ
      const offersSnap = await firestore
        .collection("offers")
        .where("productId", "==", productId)
        .get();

      const offersRaw = offersSnap.docs.map((d) => d.data());

      // í˜„ì¬ URLì˜ Offerë„ í›„ë³´ì— ë„£ê¸°
      const currentOfferBase = {
        productId,
        marketplace,
        externalId: url,
        url,
        basePrice: parsed.price,
        currency: parsed.currency,
        weightKg: 1,
      };

      const allOffers = [
        currentOfferBase,
        ...offersRaw.map((o) => ({
          productId: o.productId,
          marketplace: o.marketplace as Marketplace,
          externalId: o.externalId,
          url: o.url,
          basePrice: o.basePrice,
          currency: o.currency,
          weightKg: o.weightKg ?? 1,
        })),
      ];

      // 4) Pricing ì—”ì§„ìœ¼ë¡œ ì‹¤ê²°ì œê°€ ê³„ì‚°
      const pricedOffers = allOffers.map((o) =>
        pricingClient.compute(
          {
            marketplace: o.marketplace,
            country,
            basePrice: o.basePrice,
            currency: o.currency,
            weightKg: o.weightKg,
          },
          o
        )
      );

      // 5) ìµœì €ê°€ / ìƒëŒ€ ì ˆì•½ìœ¨ ê³„ì‚°
      const sorted = pricedOffers.sort(
        (a, b) => a.totalPriceKrw - b.totalPriceKrw
      );

      const best = sorted[0];
      const current = pricedOffers.find((o) => o.url === url) ?? best;

      const saving = current.totalPriceKrw - best.totalPriceKrw;
      const savingPct =
        current.totalPriceKrw > 0
          ? saving / current.totalPriceKrw
          : 0;

      res.json({
        product: {
          id: productId,
          title: parsed.title,
        },
        currentOffer: current,
        bestOffer: best,
        offers: sorted,
        bestPriceKrw: best.totalPriceKrw,
        baselinePriceKrw: current.totalPriceKrw,
        savingKrw: saving,
        savingPct: savingPct, // 0.18 â†’ 18% ì ˆì•½
      });
    } catch (e) {
      next(e);
    }
  }
);

// ê°„ë‹¨í•œ íƒ€ì´í‹€ ì •ê·œí™” ìœ í‹¸
function normalizeTitle(title: string): string {
  return title
    .toLowerCase()
    .replace(/\s+/g, " ")
    .replace(/[^a-z0-9ê°€-í£ ]/g, "")
    .trim();
}

1-4. index.tsì— ë¼ìš°í„° ì—°ê²°

services/api/src/index.ts (ì¼ë¶€ë¶„)

import { extRouter } from "./routes/ext";

app.use("/ext", extRouter);

ì´ì œ í™•ì¥ì—ì„œ:

fetch(`${API_BASE_URL}/ext/inspect?url=${encodeURIComponent(url)}`)
  .then(r => r.json())
  .then(data => {
    // bestPriceKrw / savingPct í™œìš©
  });

ì´ íë¦„ì´ ì™„ì„±ëœë‹¤.

â¸»

2. Cloud Run ë°°í¬ ì„¤ê³„ â€“ Review / Forecast / Scraper

ê³µí†µ ê°€ì •
	â€¢	ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ Docker ì»¨í…Œì´ë„ˆ
	â€¢	gcloud run deploy ë¡œ ë°°í¬
	â€¢	API ì„œë¹„ìŠ¤ì—ì„œ í™˜ê²½ë³€ìˆ˜ë¡œ URL ì£¼ì… (ì˜ˆ: REVIEW_BASE_URL)

â¸»

2-1. Review ì„œë¹„ìŠ¤ (FastAPI)

2-1-1. ë””ë ‰í„°ë¦¬ êµ¬ì¡°

services/review/
  app.py          # ì•„ê¹Œ ë§Œë“  FastAPI ì½”ë“œ
  requirements.txt
  Dockerfile

requirements.txt

fastapi
uvicorn[standard]
transformers
torch
scikit-learn
numpy
pandas

Dockerfile

FROM python:3.11-slim

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± (ì˜ˆ: BLAS, GCC ë“± í•„ìš” ì‹œ ì¶”ê°€)
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app.py .

ENV PORT=8080

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8080"]

2-1-2. ë¹Œë“œ & ë°°í¬ ì»¤ë§¨ë“œ ì˜ˆì‹œ

# í”„ë¡œì íŠ¸ ID / ë¦¬ì „ì€ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½
export PROJECT_ID=my-gcp-project
export REGION=asia-northeast3

cd services/review

gcloud builds submit --tag gcr.io/$PROJECT_ID/pricebuddy-review:1

gcloud run deploy pricebuddy-review \
  --image gcr.io/$PROJECT_ID/pricebuddy-review:1 \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 2

ë°°í¬ í›„ ë‚˜ì˜¨ URL ì˜ˆ:
https://pricebuddy-review-xxxxx-asia-northeast3.run.app

ì´ê±¸ services/apiì˜ í™˜ê²½ë³€ìˆ˜ REVIEW_BASE_URLì— ì„¸íŒ….

â¸»

2-2. Forecast ì„œë¹„ìŠ¤ (FastAPI + statsmodels)

2-2-1. êµ¬ì¡°

services/forecast/
  app.py
  requirements.txt
  Dockerfile

requirements.txt

fastapi
uvicorn[standard]
pandas
statsmodels
numpy

Dockerfile

FROM python:3.11-slim

RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app.py .

ENV PORT=8080

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8080"]

2-2-2. ë¹Œë“œ & ë°°í¬

cd services/forecast

gcloud builds submit --tag gcr.io/$PROJECT_ID/pricebuddy-forecast:1

gcloud run deploy pricebuddy-forecast \
  --image gcr.io/$PROJECT_ID/pricebuddy-forecast:1 \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated \
  --memory 1Gi \
  --cpu 1

API ì„œë¹„ìŠ¤ì—ì„œ FORECAST_BASE_URL ë¡œ ì‚¬ìš©.

â¸»

2-3. Scraper ì„œë¹„ìŠ¤ (Node + Playwright)

PlaywrightëŠ” ì´ë¯¸ì§€ê°€ ì¡°ê¸ˆ ë¬´ê±°ìš°ë‹ˆê¹Œ, Node baseì— Playwright ì„¤ì¹˜.

2-3-1. êµ¬ì¡°

services/scraper/
  src/
    index.ts      # Fastify/Express í•¸ë“¤ëŸ¬
    fetch-page.ts
    parsers/...
  package.json
  tsconfig.json
  Dockerfile

src/index.ts

import fastify from "fastify";
import { scrapeOffer } from "./scrape";

const app = fastify({ logger: true });

app.post("/scrape", async (req, res) => {
  const body = req.body as { marketplace: string; url: string };
  const out = await scrapeOffer({
    marketplace: body.marketplace as any,
    url: body.url,
  });
  return out;
});

const port = Number(process.env.PORT ?? 8080);

app.listen({ port, host: "0.0.0.0" }).catch((err) => {
  app.log.error(err);
  process.exit(1);
});

package.json (ì¤‘ìš” ë¶€ë¶„ë§Œ)

{
  "name": "pricebuddy-scraper",
  "version": "1.0.0",
  "scripts": {
    "build": "tsc -p tsconfig.json",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "fastify": "^4.28.0",
    "playwright": "^1.48.0",
    "cheerio": "^1.0.0"
  },
  "devDependencies": {
    "typescript": "^5.6.0"
  }
}

Dockerfile

FROM mcr.microsoft.com/playwright:v1.48.0-jammy

WORKDIR /app

COPY package.json package-lock.json* pnpm-lock.yaml* ./
RUN npm install --omit=dev

COPY tsconfig.json .
COPY src ./src

RUN npx tsc -p tsconfig.json

ENV PORT=8080

CMD ["node", "dist/index.js"]

ì—¬ê¸°ì„œëŠ” Microsoft Playwright ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì„œ
Chromium/Firefox/WebKit ì˜ì¡´ì„±ì„ ë¯¸ë¦¬ í•´ê²°.

2-3-2. ë¹Œë“œ & ë°°í¬

cd services/scraper

gcloud builds submit --tag gcr.io/$PROJECT_ID/pricebuddy-scraper:1

gcloud run deploy pricebuddy-scraper \
  --image gcr.io/$PROJECT_ID/pricebuddy-scraper:1 \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated \
  --memory 2Gi \
  --cpu 2

API ì„œë¹„ìŠ¤ì˜ SCRAPER_BASE_URL ë¡œ ì‚¬ìš©.

â¸»

3. API ì„œë¹„ìŠ¤ì—ì„œ ì™¸ë¶€ ì„œë¹„ìŠ¤ URL ì—°ê²°

services/api/.env (í˜¹ì€ Firebase Functions í™˜ê²½ë³€ìˆ˜)

SCRAPER_BASE_URL=https://pricebuddy-scraper-xxxxx-asia-northeast3.run.app
REVIEW_BASE_URL=https://pricebuddy-review-xxxxx-asia-northeast3.run.app
FORECAST_BASE_URL=https://pricebuddy-forecast-xxxxx-asia-northeast3.run.app

services/api/src/clients/review-client.ts

const REVIEW_BASE_URL = process.env.REVIEW_BASE_URL!;

export const reviewClient = {
  async analyze(productId: string, reviews: string[]) {
    const res = await fetch(`${REVIEW_BASE_URL}/analyze`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ product_id: productId, reviews }),
    });
    if (!res.ok) throw new Error(`Review service error: ${res.status}`);
    return res.json();
  },
};

services/api/src/clients/forecast-client.ts

const FORECAST_BASE_URL = process.env.FORECAST_BASE_URL!;

export const forecastClient = {
  async forecast(productId: string, history: { ts: string; price_krw: number }[]) {
    const res = await fetch(`${FORECAST_BASE_URL}/forecast`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ product_id: productId, history }),
    });
    if (!res.ok) throw new Error(`Forecast service error: ${res.status}`);
    return res.json();
  },
};

Product Detail APIì—ì„œ:

const reviewSummary = await reviewClient.analyze(productId, reviewTexts);
const forecast = await forecastClient.forecast(productId, historyPoints);

ì´ë ‡ê²Œ ì—°ê²°í•˜ë©´ ì™„ì „í•œ ë¶„ì‚° êµ¬ì¡°ê°€ ëœë‹¤.

â¸»

4. ë§ˆë¬´ë¦¬ ì •ë¦¬

ì§€ê¸ˆê¹Œì§€ ì´ì–´ì„œ ë§Œë“  ê²ƒë“¤ë¡œ PriceBuddyëŠ”:
	â€¢	FE
	â€¢	feature-based React êµ¬ì¡° + React Query
	â€¢	API
	â€¢	BFF ì—­í•  + Scraper/Pricing/Review/Forecast ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
	â€¢	ì—”ì§„
	â€¢	Scraper: Playwright + cheerio (Cloud Run)
	â€¢	Pricing: ìì²´ ë£° ì—”ì§„ (Firestore ì—°ê³„)
	â€¢	Review: ë¡œì»¬ HF ëª¨ë¸ (FastAPI + Cloud Run)
	â€¢	Forecast: ì‹œê³„ì—´ ëª¨ë¸ ì„œë¹„ìŠ¤ (FastAPI + Cloud Run)
	â€¢	í™•ì¥
	â€¢	MV3 Extension â†’ /ext/inspect ë¡œ í˜„ì¬ í˜ì´ì§€ ë”œ ì¸ì‚¬ì´íŠ¸ ì œê³µ

ê¹Œì§€ í•œ ì„¸íŠ¸ë¡œ ì™„ì„±ëœ ìƒíƒœì•¼.

ë‹¤ìŒì— ì›í•˜ë©´:
	â€¢	ì´ ì „ì²´ ì„¤ê³„ë¥¼ PriceBuddy MasterBrief â€“ â€œì •ì‹ ê°œë°œ ì„¤ê³„ v4.xâ€ í˜•íƒœë¡œ
ë§ˆí¬ë‹¤ìš´ ë¬¸ì„œë¡œ í•œ ë°©ì— ì •ë¦¬í•´ì„œ ì¤„ ìˆ˜ë„ ìˆê³ ,
	â€¢	ë˜ëŠ” ì–´ë–¤ íŒŒíŠ¸ë¶€í„° ì‹¤ì œ ì½”ë“œ êµ¬í˜„ì„ ì‹œì‘í• ì§€(ì˜ˆ: Pricing ì—”ì§„ë¶€í„°, Scraperë¶€í„°)
ë‹¨ê³„ë³„ To-do ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤„ ìˆ˜ë„ ìˆì–´.

